<Window x:Class="GameShrink.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:GameShrink.App.ViewModels"
        xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="GameShrink" Height="800" Width="1180" WindowStartupLocation="CenterScreen">

  <Window.DataContext>
    <vm:MainViewModel />
  </Window.DataContext>

  <Grid Background="{DynamicResource App.Brush.WindowBackground}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Top app bar -->
    <DockPanel Margin="24,18,24,12" LastChildFill="True">
      <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
        <md:PackIcon Kind="Compress" Width="26" Height="26" VerticalAlignment="Center" />
        <TextBlock Margin="10,0,0,0" FontSize="26" FontWeight="SemiBold" Text="GameShrink" />
      </StackPanel>

      <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" HorizontalAlignment="Right">
        <Button Style="{StaticResource AppIconButton}" Command="{Binding ShowLogCommand}" ToolTip="Show log">
          <StackPanel Orientation="Horizontal">
            <md:PackIcon Kind="FileDocumentOutline" Width="18" Height="18" Margin="0,0,8,0" />
            <TextBlock Text="Log" />
          </StackPanel>
        </Button>

        <Button Margin="10,0,0,0" Style="{StaticResource AppIconButton}" ToolTip="Toggle theme" Click="ThemeToggle_Click">
          <StackPanel Orientation="Horizontal">
            <md:PackIcon Kind="ThemeLightDark" Width="18" Height="18" Margin="0,0,8,0" />
            <TextBlock Text="Theme" />
          </StackPanel>
        </Button>
      </StackPanel>
    </DockPanel>

    <!-- Content -->
    <Grid Grid.Row="1" Margin="24,0,24,18">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Warning card -->
      <md:Card Style="{StaticResource AppCard}" Grid.Row="0">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>

          <md:PackIcon Kind="AlertCircleOutline" Width="22" Height="22" Margin="0,2,12,0" />
          <StackPanel Grid.Column="1">
            <TextBlock FontWeight="SemiBold" Text="Safety notes" />
            <TextBlock Style="{StaticResource AppHelperText}" TextWrapping="Wrap">
              Online games / anti-cheat may dislike any on-disk changes (including compression attribute changes). Game updates can overwrite files and remove compression for updated items.
            </TextBlock>
          </StackPanel>
        </Grid>
      </md:Card>

      <!-- Main tabs -->
      <TabControl Grid.Row="1">
        <TabItem>
          <TabItem.Header>
            <StackPanel Orientation="Horizontal">
              <md:PackIcon Kind="FolderOutline" Width="18" Height="18" Margin="0,0,8,0" />
              <TextBlock Text="Select" />
            </StackPanel>
          </TabItem.Header>

          <Grid Margin="0,16,0,0">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="0">
              <StackPanel>
                <TextBlock FontWeight="SemiBold" Text="Game folder" />
                <TextBlock Style="{StaticResource AppHelperText}" TextWrapping="Wrap" Margin="0,4,0,0">
                  Example: SteamLibrary\steamapps\common\Game. Reparse points (symlinks/junctions) are not followed.
                </TextBlock>

                <Grid Margin="0,12,0,0">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>

                  <TextBox Text="{Binding SelectedFolder, UpdateSourceTrigger=PropertyChanged}" md:HintAssist.Hint="Folder path" />

                  <Button Grid.Column="1" Margin="10,0,0,0" Style="{StaticResource AppIconButton}" Command="{Binding BrowseCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="FolderOpenOutline" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Browse" />
                    </StackPanel>
                  </Button>

                  <Button Grid.Column="2" Margin="10,0,0,0" Style="{StaticResource AppPrimaryButton}" Command="{Binding AnalyzeCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="Magnify" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Analyze" />
                    </StackPanel>
                  </Button>
                </Grid>

                <TextBlock Margin="0,10,0,0" Style="{StaticResource AppHelperText}" TextWrapping="Wrap">
                  Status: <Run FontWeight="SemiBold" Text="{Binding StatusText}" />
                </TextBlock>
              </StackPanel>
            </md:Card>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="1">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="Detected libraries" />
                  <TextBlock Style="{StaticResource AppHelperText}" Text="Select a root to quickly paste paths." />

                  <ComboBox Margin="0,10,0,0" ItemsSource="{Binding DetectedLibraryRoots}" SelectedItem="{Binding SelectedLibraryRoot}" />
                </StackPanel>

                <Button Grid.Column="1" Style="{StaticResource AppIconButton}" Command="{Binding DetectLibrariesCommand}" Margin="12,0,0,0">
                  <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="Refresh" Width="18" Height="18" Margin="0,0,8,0" />
                    <TextBlock Text="Rescan" />
                  </StackPanel>
                </Button>
              </Grid>
            </md:Card>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="2" Margin="0">
              <StackPanel>
                <TextBlock FontWeight="SemiBold" Text="Tips" />
                <TextBlock Style="{StaticResource AppHelperText}" TextWrapping="Wrap" Margin="0,6,0,0">
                  For Steam: pick a folder under steamapps\common. For Epic: pick the game install folder.
                </TextBlock>
              </StackPanel>
            </md:Card>
          </Grid>
        </TabItem>

        <TabItem>
          <TabItem.Header>
            <StackPanel Orientation="Horizontal">
              <md:PackIcon Kind="ChartBar" Width="18" Height="18" Margin="0,0,8,0" />
              <TextBlock Text="Analysis" />
            </StackPanel>
          </TabItem.Header>

          <Grid Margin="0,16,0,0">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <UniformGrid Columns="4" Margin="0,0,0,16">
              <md:Card Style="{StaticResource AppCard}" Margin="0,0,12,0">
                <StackPanel>
                  <TextBlock Style="{StaticResource AppHelperText}" Text="Total size" />
                  <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding AnalysisTotalSizeText}" />
                </StackPanel>
              </md:Card>
              <md:Card Style="{StaticResource AppCard}" Margin="0,0,12,0">
                <StackPanel>
                  <TextBlock Style="{StaticResource AppHelperText}" Text="File count" />
                  <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding AnalysisFileCountText}" />
                </StackPanel>
              </md:Card>
              <md:Card Style="{StaticResource AppCard}" Margin="0,0,12,0">
                <StackPanel>
                  <TextBlock Style="{StaticResource AppHelperText}" Text="Estimated savings" />
                  <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding AnalysisEstimatedSavingsText}" />
                </StackPanel>
              </md:Card>
              <md:Card Style="{StaticResource AppCard}" Margin="0">
                <StackPanel>
                  <TextBlock Style="{StaticResource AppHelperText}" Text="Volume" />
                  <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding AnalysisVolumeText}" />
                </StackPanel>
              </md:Card>
            </UniformGrid>

            <Grid Grid.Row="1">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <md:Card Style="{StaticResource AppCard}" Margin="0,0,12,0">
                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="Most compressible files" />
                  <DataGrid ItemsSource="{Binding TopCompressibleFiles}" AutoGenerateColumns="False" IsReadOnly="True" Margin="0,10,0,0">
                    <DataGrid.Columns>
                      <DataGridTextColumn Header="File" Binding="{Binding RelativePath}" Width="*" />
                      <DataGridTextColumn Header="Size" Binding="{Binding SizeText}" Width="120" />
                      <DataGridTextColumn Header="Est. save" Binding="{Binding EstimatedSavingsText}" Width="120" />
                      <DataGridTextColumn Header="Ratio" Binding="{Binding EstimatedRatioText}" Width="90" />
                    </DataGrid.Columns>
                  </DataGrid>
                </StackPanel>
              </md:Card>

              <md:Card Style="{StaticResource AppCard}" Grid.Column="1" Margin="0">
                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="Most compressible folders" />
                  <DataGrid ItemsSource="{Binding TopCompressibleFolders}" AutoGenerateColumns="False" IsReadOnly="True" Margin="0,10,0,0">
                    <DataGrid.Columns>
                      <DataGridTextColumn Header="Folder" Binding="{Binding Folder}" Width="*" />
                      <DataGridTextColumn Header="Est. save" Binding="{Binding SavingsText}" Width="120" />
                    </DataGrid.Columns>
                  </DataGrid>
                </StackPanel>
              </md:Card>
            </Grid>
          </Grid>
        </TabItem>

        <TabItem>
          <TabItem.Header>
            <StackPanel Orientation="Horizontal">
              <md:PackIcon Kind="PlayCircleOutline" Width="18" Height="18" Margin="0,0,8,0" />
              <TextBlock Text="Run" />
            </StackPanel>
          </TabItem.Header>

          <Grid Margin="0,16,0,0">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="0">
              <StackPanel>
                <TextBlock FontWeight="SemiBold" Text="Profile" />
                <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                  <RadioButton Content="Safe (NTFS/standard)" IsChecked="{Binding IsSafeProfileSelected}" Style="{StaticResource MaterialDesignRadioButton}"/>
                  <RadioButton Margin="18,0,0,0" Content="Stronger (compact /EXE:LZX)" IsChecked="{Binding IsStrongerProfileSelected}" Style="{StaticResource MaterialDesignRadioButton}"/>
                  <CheckBox Margin="18,0,0,0" Content="Skip low-savings files (3–5%)" IsChecked="{Binding SkipLowSavingsFiles}" Style="{StaticResource MaterialDesignCheckBox}"/>
                </StackPanel>
                <TextBlock Style="{StaticResource AppHelperText}" Margin="0,8,0,0" TextWrapping="Wrap">
                  Stronger mode can save more space, but may increase CPU cost during reads.
                </TextBlock>
              </StackPanel>
            </md:Card>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="1">
              <StackPanel>
                <TextBlock FontWeight="SemiBold" Text="Actions" />
                <WrapPanel Margin="0,12,0,0" ItemHeight="40" ItemWidth="190">
                  <Button Style="{StaticResource AppPrimaryButton}" Command="{Binding StartCompressionCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="Compress" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Start compression" />
                    </StackPanel>
                  </Button>

                  <Button Style="{StaticResource AppIconButton}" Command="{Binding PauseCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="PauseCircleOutline" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Pause" />
                    </StackPanel>
                  </Button>

                  <Button Style="{StaticResource AppIconButton}" Command="{Binding ResumeCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="PlayCircleOutline" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Resume" />
                    </StackPanel>
                  </Button>

                  <Button Style="{StaticResource AppIconButton}" Command="{Binding StopCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="StopCircleOutline" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Stop" />
                    </StackPanel>
                  </Button>

                  <Button Style="{StaticResource AppDangerButton}" Command="{Binding RollbackCommand}">
                    <StackPanel Orientation="Horizontal">
                      <md:PackIcon Kind="BackupRestore" Width="18" Height="18" Margin="0,0,8,0" />
                      <TextBlock Text="Rollback" />
                    </StackPanel>
                  </Button>
                </WrapPanel>
              </StackPanel>
            </md:Card>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="2">
              <StackPanel>
                <TextBlock FontWeight="SemiBold" Text="Progress" />

                <Grid Margin="0,12,0,0">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>

                  <ProgressBar Height="8" Minimum="0" Maximum="100" Value="{Binding ProgressPercent}" IsIndeterminate="{Binding IsProgressIndeterminate}" Style="{StaticResource MaterialDesignLinearProgressBar}" />
                  <TextBlock Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" Text="{Binding ProgressPercent, StringFormat={}{0:0}%}" />
                </Grid>

                <TextBlock Margin="0,10,0,0" Text="{Binding ProgressStatusText}" TextWrapping="Wrap" />
                <TextBlock Margin="0,4,0,0" Style="{StaticResource AppHelperText}" Text="{Binding ProgressCurrentFileText}" TextWrapping="Wrap" />

                <md:Card Margin="0,12,0,0" Padding="12" Background="{DynamicResource MaterialDesignCardBackground}">
                  <TextBlock Text="{Binding LastOperationText}" TextWrapping="Wrap" />
                </md:Card>
              </StackPanel>
            </md:Card>

            <md:Card Style="{StaticResource AppCard}" Grid.Row="3" Margin="0" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}">
              <StackPanel Orientation="Horizontal">
                <md:PackIcon Kind="ProgressClock" Width="18" Height="18" Margin="0,0,10,0" />
                <TextBlock Text="Working…" FontWeight="SemiBold" />
              </StackPanel>
            </md:Card>
          </Grid>
        </TabItem>

        <TabItem>
          <TabItem.Header>
            <StackPanel Orientation="Horizontal">
              <md:PackIcon Kind="Tune" Width="18" Height="18" Margin="0,0,8,0" />
              <TextBlock Text="Settings" />
            </StackPanel>
          </TabItem.Header>

          <Grid Margin="0,16,0,0">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Style="{StaticResource AppHelperText}" TextWrapping="Wrap">
              Exclusions affect analysis/estimation and "skip low-savings". Compression itself is done by compact.exe on the chosen folder.
            </TextBlock>

            <Grid Grid.Row="1" Margin="0,16,0,0">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <md:Card Style="{StaticResource AppCard}" Margin="0,0,12,0">
                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="Excluded extensions" />
                  <TextBlock Style="{StaticResource AppHelperText}" Text="One per line (example: .tmp)" />
                  <TextBox Margin="0,10,0,0" AcceptsReturn="True" Text="{Binding ExcludedExtensionsText, UpdateSourceTrigger=PropertyChanged}" />
                </StackPanel>
              </md:Card>

              <md:Card Style="{StaticResource AppCard}" Grid.Column="1" Margin="0">
                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="Excluded folder fragments" />
                  <TextBlock Style="{StaticResource AppHelperText}" Text="Matches folder names (not the whole path)." />
                  <TextBox Margin="0,10,0,0" AcceptsReturn="True" Text="{Binding ExcludedFolderFragmentsText, UpdateSourceTrigger=PropertyChanged}" />
                </StackPanel>
              </md:Card>
            </Grid>
          </Grid>
        </TabItem>
      </TabControl>
    </Grid>

    <!-- Bottom status bar -->
    <StatusBar Grid.Row="2">
      <StatusBarItem>
        <StackPanel Orientation="Horizontal">
          <md:PackIcon Kind="InformationOutline" Width="16" Height="16" Margin="0,0,6,0" />
          <TextBlock Text="{Binding StatusText}" />
        </StackPanel>
      </StatusBarItem>
      <Separator />
      <StatusBarItem>
        <TextBlock Text="{Binding AppDataText}" />
      </StatusBarItem>
    </StatusBar>
  </Grid>
</Window>
